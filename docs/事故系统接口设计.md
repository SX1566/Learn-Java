## 目录

1. [术语表](#1-术语表)
2. [分类标准](#2-分类标准)
    - 2.1 [Table](#21-table)
    - 2.2 [HTTP](#22-http)
        - 2.2.1 [获取指定一级分类下的二级分类列表](#221-获取指定一级分类下的二级分类列表按一级分类的编码)
    - 2.3. [Service](#23-service)
        - 2.3.1 [获取指定一级分类下的二级分类列表](#231-获取指定一级分类下的二级分类列表)
3. [事故报案](#3-事故报案)
    - 3.1 [Table](#31-table)
    - 3.2 [HTTP](#32-http)
        - 3.2.1 [获取独立视图的分页数据](#321-获取独立视图的分页数据)
        - 3.2.2 [获取指定编号的报案信息](#322-获取指定编号的报案信息)
        - 3.2.3 [提交事故报案信息](#323-提交事故报案信息)
        - 3.2.4 [更新事故报案信息](#324-更新事故报案信息)
    - 3.3. [Service](#33-service)
    - 3.4. [Dao](#34-dao)
4. [事故登记](#4-事故登记)
    - 4.1 [Table](#41-table)
    - 4.2 [HTTP](#42-http)
        - 4.2.1 [获取汇总统计信息](#421-获取汇总统计信息)
        - 4.2.2 [获取待登记和待审核案件信息](#422-获取待登记和待审核案件信息)
        - 4.2.3 [获取已审案件信息](#423-获取已审案件信息)
5. [事故报告](#5-事故报告)
6. [事故处理](#6-事故处理)
7. [事故结案](#7-事故结案)

## 1. 术语表

Name           | Description
---------------|---------------
{context-path} | 上下文路径，由系统配置确定，固定设置为 `/accident`。
Enabled        | 状态为启用状态
Disabled       | 状态为被禁用状态

## 2. 分类标准

### 2.1. Table

使用通用的 [simter-category](https://github.com/simter/simter-category) 模块的数据表结构（st_category）：

```
create table st_category (
  id     serial primary key,
  pid    int references st_category on delete cascade,
  status smallint     not null,
  name   varchar(100) not null,
  sn     varchar(50)  not null,
  constraint st_category_unique_pid_name unique (pid, name),
  constraint st_category_unique_pid_sn unique (pid, sn)
);
comment on table st_category is '分类';
comment on column st_category.pid is '所属父类 ID';
comment on column st_category.status is '状态: 1-草稿, 2-正常, 4-已禁用, 8-已删除';
comment on column st_category.name is '名称';
comment on column st_category.sn is '编码或排序号';

-- 霸占 ID=1 为固定的根节点
insert into st_category (pid, status, name, sn) values (null, 0, 'ROOT', '0');
```

> 注意 pid+name 或 pid+sn 都是有唯一性约束的，这样可以保证同一分类下不会出现同名或相同编号（也可能是排序号）的信息。

**事故的分类标准数据全部附加到 '交通事故分类标准' 节点下，每个分类标准下只支持最多 1 级的子分类，降低事故分类标准的复杂性。**

**事故分类标准的一级分类**为事故性质、事故形态、事故责任等，详细见《[交通事故管理业务模块系统设计报告_20180618.docx](https://gitee.com/gftaxi/info-team/commit/8d19c55c98251cccd343728eeb663e8d8f4220fe)》的《附件3、交通事故管理业务相关分类标准》的“主要内容”列。导入数据时，sn 使用一级分类的拼音首字母大写，作为一级分类的唯一编码。

**事故分类标准的二级分类**如事故性质的“财产损失事故、伤人事故、死亡事故”，详细见《附件3、交通事故管理业务相关分类标准》的“分类标准”列。导入数据时，sn 使用二级分类的录入顺序号的字符串数字格式，长度按最大顺序号。如事故性质有3个二级分类，最大顺序号为 3，故对应的 sn 分别为“财产损失事故的 sn='1'、伤人事故的 sn='2'、死亡事故的 sn='3'”。又如行驶方向的二级分类共有 12 个，这时 sn 就从 '01' 开始而不是 '1'。这样做主要是因为 sn 是字符类型，对二级分类是用来做排序用的，不作为编码使用。

可以参考如下脚本初始化事故分类标准的数据：

```
-- 交通事故分类标准（ID=2，附加到 ID=1 的 ROOT 节点下）
insert into st_category (pid, status, name, sn)
values (1, 0, '交通事故分类标准', 'JTSG_CATEGORY');

-- 交通事故分类标准/*
insert into st_category (pid, status, name, sn)
select 2, 0, name, cn_first_char(name) as sn
from (select unnest(array['事故性质','事故形态']) as name) t;

-- 交通事故分类标准/事故性质/*
insert into st_category (pid, status, name, sn)
select (select id from st_category where pid = 2 and name = '事故性质'), 0, name, (row_number() over())::text as sn
from (select unnest(array['财产损失事故','伤人事故', '死亡事故']) as name) t;
```

> cn_first_char 是获取汉字拼音首字母大写的一个自定义函数，已收录在 [sql/postgres/data.sql](https://gitee.com/gftaxi/gftaxi-traffic-accident/blob/b98bfbd659256337322ff6ebce7e76a0088c9d58/gftaxi-traffic-accident-data/src/main/resources/cn/gftaxi/traffic/accident/sql/postgres/data.sql)。

使用如下脚本可以方便的查阅已导入的分类标准数据：

```
with recursive t(id, sn, name) as (
  -- 交通事故分类标准 节点
  select id, array[sn::text], array[name::text] from st_category where id = 100

  union all 

  -- 递归获取所有后代节点，并按 full-sn 排序
  select c.id, p.sn || c.sn::text, p.name || c.name::text
  from st_category c inner join t as p on c.pid = p.id
) select * from t order by t.sn; 
```

### 2.2. HTTP

#### 2.2.1. 获取指定一级分类下的二级分类列表（按一级分类的编码）

可用于表单中获取指定一级分类下的二级分类下拉列表。

**请求：**

```
GET {context-path}/category/{sn}/children?include-disabled={includeDisabled}
```
Name              | Require | Description
------------------|---------|---------------
{sn}              | true    | 一级分类编码，如 "SGXZ"（事故性质）
{includeDisabled} | false   | 是否包含 `Disabled` 状态的二级分类，不指定默认仅返回 `Enabled` 状态，可指定为 `true` 返回 `Enabled` 和 `Disabled` 状态的二级分类（不区分大小写）。

**响应：**

返回结果是按子二级分类的 status 正序 + sn 正序排序好的列表。

```
200 OK
Content-Type: application/json;charset=utf-8

[{sn, name, status}, ...]
```
Name   | Require | Description
-------|---------|-------------
sn     | true    | 排序号
name   | true    | 名称
status | false   | 状态，`Enabled` 或 `Disabled`，如果请求中没有指定 include-disabled 参数，则不返回此属性

### 2.3. Service

位置：`cn.gftaxi.traffic.accident.service.AccidentCategoryService`。

#### 2.3.1. 获取指定一级分类下的二级分类列表

```kotlin
/**
 * 获取指定一级分类下的二级分类列表。
 * 
 * 返回结果按照一级分类 sn 正序 + 二级分类 status 正序 + 二级分类 sn 正序排序。
 * 
 * @param[includeDisabledStatus] false 仅返回 `Enabled` 状态， true 包含 `Enabled` 和 `Disabled` 状态
 * @param[primaryCategorySNs] 一级分类编码列表
 * @return 二级分类信息的 [Flux] 信号，无则返回 [Flux.empty]
 */
fun findSecondaryCategories(includeDisabledStatus : Boolean, vararg primaryCategorySNs : String) : Flux<SecondaryCategoryDto>
```

**`SecondaryCategoryDto` 结构：**

Name   | Description
-------|-------------
belong | 所属一级分类编码
sn     | 二级分类排序号
name   | 二级分类名称

## 3. 事故报案

### 3.1. Table

表名为 `gf_accident_draft`，建表语句见 [data.sql/gf_accident_draft](https://gitee.com/gftaxi/gftaxi-traffic-accident/blob/master/gftaxi-traffic-accident-data/src/main/resources/cn/gftaxi/traffic/accident/sql/postgres/schema.sql#L7)。

### 3.2. HTTP

#### 3.2.1. 获取独立视图的分页数据

**请求：**

```
GET {context-path}/accident-draft?status=x&pageNo=x&pageSize=x&search=x
```

Name     | Require | Description
---------|---------|---------------
status   | false   | 状态，Todo-待登记、Done-已登记、无-全部
pageNo   | false   | 页码，默认为 1
pageSize | false   | 页容量，默认为 25
search   | false   | 模糊搜索值，模糊匹配事故编号、车号、司机

**响应：**

返回的数据列表默认按事故编号逆序排序。

```
200 OK
Content-Type : application/json;charset=utf-8

{
  count, pageNo, pageSize,
  rows: [
    {code, status, carPlate, driverName, happenTime, reportTime, location, 
     hitForm, hitType, overdue, source, authorName, authorId},
    ...
  ]
}
```

Name            | Require | Description
----------------|---------|---------------
count           | true    | 符合条件的总条目数
rows/code       | true    | 事故编号，格式为 yyyyMMdd_nn
rows/status     | true    | 状态，Todo 或 Done
rows/carPlate   | true    | 事故车号，如 "粤A123456"
rows/driverName | true    | 当事司机姓名
rows/happenTime | true    | 事发时间，格式为 yyyy-MM-dd HH:mm
rows/reportTime | true    | 报案时间，格式为 yyyy-MM-dd HH:mm
rows/location   | true    | 事发地点
rows/hitForm    | true    | 事故形态，如 "车辆间事故"
rows/hitType    | true    | 碰撞类型，如 "追尾碰撞"
rows/overdue    | true    | 是否逾期报案，true-预期、false-正常
rows/source     | true    | 报案来源
rows/authorName | true    | 接案人姓名
rows/authorId   | true    | 接案人标识

#### 3.2.2. 获取指定编号的报案信息

**请求：**

```
GET {context-path}/accident-draft/{code}
```

Name | Require | Description
-----|---------|-------------
code | true    | 事故编号

**响应：**

```
200 OK
Content-Type : application/json;charset=utf-8

{
  code, status, happenTime, carPlate, motorcade, driverName, authorName,
  hitForm, hitType, reportTime, overdue, location, describe, source
}
```

Name       | Require | Description
-----------|---------|---------------
code       | true    | 事故编码
status     | true    | 状态，Todo 或 Done
happenTime | true    | 事故编号，格式为 yyyyMMdd_nn
carPlate   | true    | 事故车号，如 "粤A123456"
motorcade  | true    | 所属车队
driverName | true    | 当事司机姓名
authorName | true    | 接案人姓名
hitForm    | true    | 事故形态，如 "车辆间事故"
hitType    | true    | 碰撞类型，如 "追尾碰撞"
reportTime | true    | 报案时间，格式为 yyyy-MM-dd HH:mm
overdue    | true    | 是否逾期报案，true-预期、false-正常
location   | true    | 事发地点
describe   | false   | 简要描述
source     | true    | 报案来源

#### 3.2.3. 提交事故报案信息

**请求：**

```
POST {context-path}/accident-draft

{
  carPlate, driverName, happenTime, location, hitForm,
  hitType, describe, source, authorName, authorId
}
```

Name       | Require | Description
-----------|---------|-------------
carPlate   | true    | 事故车号
driverName | true    | 当事司机
happenTime | true    | 事发时间
hitForm    | true    | 事故形态
hitType    | true    | 碰撞类型
describe   | false   | 简要描述
source     | true    | 报案来源
authorName | true    | 接案人
authorId   | true    | 接案人账号

**响应：**

```
201 Created
Content-Type : application/json;charset=utf-8

{code}
```

Name | Require | Description
-----|---------|-------------
code | true    | 系统自动生成的事故编号

#### 3.2.4. 更新事故报案信息

**请求：**

```
PUT {context-path}/accident-draft/{code}

{
  carPlate, driverName, happenTime, location, 
  hitForm, hitType, describe, source
}
```

Name       | Require | Description
-----------|---------|-------------
code       | true    | 事故编号
carPlate   | true    | 事故车号
driverName | true    | 当事司机
happenTime | true    | 事发时间
hitForm    | true    | 事故形态
hitType    | true    | 碰撞类型
describe   | false   | 简要描述

**响应：**

```
204 No Content
```

### 3.3. Service

类名 `cn.gftaxi.traffic.accident.service.AccidentDraftService`，详见[源码](https://gitee.com/gftaxi/gftaxi-traffic-accident/blob/master/gftaxi-traffic-accident-data/src/main/kotlin/cn/gftaxi/traffic/accident/service/AccidentDraftService.kt)中的注释说明。

### 3.4. Dao

类名 `cn.gftaxi.traffic.accident.dao.AccidentDraftDao`，详见[源码](https://gitee.com/gftaxi/gftaxi-traffic-accident/blob/master/gftaxi-traffic-accident-data/src/main/kotlin/cn/gftaxi/traffic/accident/dao/AccidentDraftDao.kt)中的注释说明。

## 4. 事故登记

### 4.1. Table

### 4.2. HTTP

#### 4.2.1. 获取汇总统计信息

**请求：**

```
GET {context-path}/accident-register/stat/summary

```

**响应：**

返回的数据列表按"本月>上月>本年"排序。

```
200 OK
Content-Type : application/json;charset=utf-8

[
  {scope, total, checked, checking, drafting, overdueDraft, overdueRegister},
  ...
]
```

Name            | Description
----------------|-------------
scope           | 范围，本月、上月 和 本年
total           | 事故报案总数
checked         | 已登已审案件数
checking        | 已登在审案件数，包含审核不通过
drafting        | 尚未登记案件数
overdueDraft    | 逾期报案案件数
overdueRegister | 逾期登记案件数

#### 4.2.2. 获取待登记和待审核案件信息

**请求：**

```
GET {context-path}/accident-register/todo?status={status}
```

Name   | Require | Description
-------|---------|-------------
status | false   | 状态，Draft-待登记、ToCheck-已登待审、无-全部

**响应：**

返回的数据列表默认按事故编号逆序排序。

```
200 OK
Content-Type : application/json;charset=utf-8

[
  {code, carPlate, driverName, happenTime, location, hitForm, hitType, 
   authorName, reportTime, overdueReport, registerTime, overdueRegister},
  ...
]
```

Name            | Require | Description
----------------|---------|-------------
code            | true    | 事故编号，格式为 yyyyMMdd_nn
carPlate        | true    | 事故车号，如 "粤A123456"
driverName      | true    | 当事司机姓名
happenTime      | true    | 事发时间，格式为 yyyy-MM-dd HH:mm
location        | true    | 事发地点
hitForm         | true    | 事故形态，如 "车辆间事故"
hitType         | true    | 碰撞类型，如 "追尾碰撞"
authorName      | true    | 接案人姓名
reportTime      | true    | 报案时间，格式为 yyyy-MM-dd HH:mm
overdueReport   | true    | 逾期报案，如果逾期则显示时间如：2h 表示2小时、1d8h 表示1天8小时。如果未逾期则显示"否"
submitTime      | false   | 提交时间，当用户有"登记信息审核员"角色时才返回
overdueRegister | false   | 逾期登记，当用户有"登记信息审核员"角色时才返回。如果逾期则显示时间如：2h 表示2小时、1d8h 表示1天8小时。如果未逾期则显示"否"

#### 4.2.3. 获取已审案件信息

**请求：**

```
GET {context-path}/accident-register/checked?status={status}&pageNo={pageNo}&pageSize={pageSize}
```

Name     | Require | Description
---------|---------|-------------
status   | false   | 状态，Approved-审核为通过、Rejected-审核不通过、无-全部
pageNo   | false   | 页码，默认为 1
pageSize | false   | 页容量，默认为 25

**响应：**

返回的数据列表默认按事故编号逆序排序。

```
200 OK
Content-Type : application/json;charset=utf-8

{
  count, pageNo, pageSize,
  rows: [
    {code, carPlate, driverName, checkMsg, attachmentName, attachmentId, 
     status, auditorName, checkCount, checkedTime},
    ...
  ]
}
```

Name                | Description
--------------------|-------------
count               | 符合条件的总条目数
pageNo              | 页码
pageSize            | 页容量
rows/code           | 事故编号，格式为 yyyyMMdd\_nn
rows/carPlate       | 事故车号，如 "粤A123456"
rows/driverName     | 当事司机名称
rows/checkComment   | 审查意见
rows/attachmentName | 附件名称，如 yyyyMMdd\_nn\_审核结果.pdf
rows/attachmentId   | 附件 ID
rows/checkResult    | 审核标记(审核状态)，通过、修正和退回
rows/checkerName    | 审核人姓名
rows/checkedCount   | 审核次数
rows/checkedTime    | 审核时间，格式为 yyyy-MM-dd HH:mm

## 5. 事故报告

## 6. 事故处理

## 7. 事故结案

## n. MORE